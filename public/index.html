<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meal Tracker - AI Nutrition Analysis</title>
    <meta name="description" content="Track your meals with AI-powered nutrition analysis">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // Lucide icons as inline SVG components
        const Camera = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/>
                <circle cx="12" cy="13" r="3"/>
            </svg>
        );

        const Footprints = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 10 3.8 10 5.5c0 3.11-2 5.66-2 8.68V16a2 2 0 1 1-4 0Z"/>
                <path d="M20 20v-2.38c0-2.12 1.03-3.12 1-5.62-.03-2.72-1.49-6-4.5-6C14.63 6 14 7.8 14 9.5c0 3.11 2 5.66 2 8.68V20a2 2 0 1 0 4 0Z"/>
            </svg>
        );

        const TrendingUp = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/>
                <polyline points="16 7 22 7 22 13"/>
            </svg>
        );

        const Plus = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
        );

        const X = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        );

        function MealTrackerApp() {
            const availableModels = [
                { value: 'claude-sonnet-4-20250514', label: 'Claude Sonnet 4 (high accuracy)' },
                { value: 'claude-3-5-haiku-latest', label: 'Claude 3.5 Haiku (lower cost)' }
            ];
            const [meals, setMeals] = useState([]);
            const [steps, setSteps] = useState(0);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [selectedModel, setSelectedModel] = useState(availableModels[0].value);
            const [showCamera, setShowCamera] = useState(false);
            const [capturedImage, setCapturedImage] = useState(null);
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const fileInputRef = useRef(null);
            const streamRef = useRef(null);

            // Load meals from localStorage on mount
            useEffect(() => {
                const savedMeals = localStorage.getItem('meals');
                if (savedMeals) {
                    setMeals(JSON.parse(savedMeals));
                }
            }, []);

            // Save meals to localStorage whenever they change
            useEffect(() => {
                localStorage.setItem('meals', JSON.stringify(meals));
            }, [meals]);

            // Step counter using device motion
            useEffect(() => {
                let stepCount = parseInt(localStorage.getItem('dailySteps') || '0');
                setSteps(stepCount);

                const now = new Date();
                const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                const msUntilMidnight = tomorrow - now;
                
                const midnightTimer = setTimeout(() => {
                    localStorage.setItem('dailySteps', '0');
                    setSteps(0);
                }, msUntilMidnight);

                return () => clearTimeout(midnightTimer);
            }, []);

            const requestPedometerPermission = async () => {
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    try {
                        const permission = await DeviceMotionEvent.requestPermission();
                        if (permission === 'granted') {
                            startStepCounting();
                            alert('Step counter enabled! Start walking to see it update.');
                        }
                    } catch (error) {
                        alert('Permission denied. Step counting requires motion sensor access.');
                    }
                } else {
                    alert('Step counter is only available on mobile devices with motion sensors (iPhone, Android phones).');
                }
            };

            const startStepCounting = () => {
                let lastY = 0;
                let threshold = 1.2;
                
                window.addEventListener('devicemotion', (event) => {
                    if (event.accelerationIncludingGravity) {
                        const y = event.accelerationIncludingGravity.y;
                        if (Math.abs(y - lastY) > threshold) {
                            const newSteps = steps + 1;
                            setSteps(newSteps);
                            localStorage.setItem('dailySteps', newSteps.toString());
                        }
                        lastY = y;
                    }
                });
            };

            const startCamera = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: { ideal: 'environment' },
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        } 
                    });
                    streamRef.current = stream;
                    setShowCamera(true);
                    
                    setTimeout(() => {
                        if (videoRef.current) {
                            videoRef.current.srcObject = stream;
                            videoRef.current.play().catch(err => {
                                console.error('Play error:', err);
                            });
                        }
                    }, 100);
                } catch (err) {
                    console.error('Camera access denied:', err);
                    alert('Camera access denied. Please grant camera permission or use the Upload Photo option instead.');
                }
            };

            const stopCamera = () => {
                if (streamRef.current) {
                    streamRef.current.getTracks().forEach(track => track.stop());
                    streamRef.current = null;
                }
                setShowCamera(false);
                setCapturedImage(null);
            };

            const capturePhoto = () => {
                const video = videoRef.current;
                const canvas = canvasRef.current;
                
                if (video && canvas) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0);
                    const imageData = canvas.toDataURL('image/jpeg', 0.8);
                    setCapturedImage(imageData);
                    stopCamera();
                    analyzeMeal(imageData);
                }
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setCapturedImage(e.target.result);
                        analyzeMeal(e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const analyzeMeal = async (imageData) => {
                setIsAnalyzing(true);
                
                try {
                    const response = await fetch('/api/analyze-meal', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ imageData, model: selectedModel })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || `API error: ${response.status}`);
                    }

                    const nutritionData = await response.json();
                    
                    const newMeal = {
                        id: Date.now(),
                        timestamp: new Date().toLocaleString(),
                        image: imageData,
                        ...nutritionData
                    };
                    
                    setMeals(prev => [newMeal, ...prev]);
                } catch (error) {
                    console.error('Analysis error:', error);
                    alert('Failed to analyze meal. ' + error.message);
                } finally {
                    setIsAnalyzing(false);
                    setCapturedImage(null);
                }
            };

            const deleteMeal = (id) => {
                setMeals(prev => prev.filter(meal => meal.id !== id));
            };

            const todaysTotals = meals.reduce((acc, meal) => ({
                calories: acc.calories + (meal.calories || 0),
                protein: acc.protein + (meal.protein || 0),
                carbs: acc.carbs + (meal.carbs || 0),
                fat: acc.fat + (meal.fat || 0),
                fiber: acc.fiber + (meal.fiber || 0)
            }), { calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0 });

            return (
                <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50">
                    <div className="max-w-4xl mx-auto p-4">
                        {/* Header */}
                        <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
                            <h1 className="text-3xl font-bold text-gray-800 mb-4">üçΩÔ∏è Meal Tracker</h1>
                            
                            {/* Daily Summary Cards */}
                            <div className="grid grid-cols-2 gap-4 mb-4">
                                <div className="bg-gradient-to-br from-orange-100 to-orange-200 rounded-xl p-4">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className="text-orange-700 text-sm font-medium">Today's Calories</p>
                                            <p className="text-3xl font-bold text-orange-900">{Math.round(todaysTotals.calories)}</p>
                                        </div>
                                        <TrendingUp size={32} className="text-orange-600" />
                                    </div>
                                </div>
                                
                                <div className="bg-gradient-to-br from-blue-100 to-blue-200 rounded-xl p-4">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className="text-blue-700 text-sm font-medium">Steps Today</p>
                                            <p className="text-3xl font-bold text-blue-900">{steps.toLocaleString()}</p>
                                        </div>
                                        <Footprints size={32} className="text-blue-600" />
                                    </div>
                                </div>
                            </div>

                            {/* Macros Summary */}
                            <div className="grid grid-cols-4 gap-3 mb-4">
                                <div className="bg-purple-50 rounded-lg p-3 text-center">
                                    <p className="text-xs text-purple-600 font-medium">Protein</p>
                                    <p className="text-xl font-bold text-purple-900">{Math.round(todaysTotals.protein)}g</p>
                                </div>
                                <div className="bg-yellow-50 rounded-lg p-3 text-center">
                                    <p className="text-xs text-yellow-600 font-medium">Carbs</p>
                                    <p className="text-xl font-bold text-yellow-900">{Math.round(todaysTotals.carbs)}g</p>
                                </div>
                                <div className="bg-red-50 rounded-lg p-3 text-center">
                                    <p className="text-xs text-red-600 font-medium">Fat</p>
                                    <p className="text-xl font-bold text-red-900">{Math.round(todaysTotals.fat)}g</p>
                                </div>
                                <div className="bg-green-50 rounded-lg p-3 text-center">
                                    <p className="text-xs text-green-600 font-medium">Fiber</p>
                                    <p className="text-xl font-bold text-green-900">{Math.round(todaysTotals.fiber)}g</p>
                                </div>
                            </div>

                            <div className="mb-4">
                                <label htmlFor="model-select" className="block text-sm font-medium text-gray-700 mb-2">
                                    AI Model
                                </label>
                                <select
                                    id="model-select"
                                    value={selectedModel}
                                    onChange={(event) => setSelectedModel(event.target.value)}
                                    className="w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 shadow-sm focus:border-green-500 focus:outline-none focus:ring-2 focus:ring-green-200"
                                >
                                    {availableModels.map((modelOption) => (
                                        <option key={modelOption.value} value={modelOption.value}>
                                            {modelOption.label}
                                        </option>
                                    ))}
                                </select>
                            </div>

                            {/* Action Buttons */}
                            <div className="grid grid-cols-2 gap-3">
                                <button
                                    onClick={startCamera}
                                    className="bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl py-3 px-4 font-semibold flex items-center justify-center gap-2 hover:from-green-600 hover:to-green-700 transition-all shadow-md"
                                >
                                    <Camera size={20} />
                                    Scan Meal
                                </button>
                                
                                <button
                                    onClick={() => fileInputRef.current.click()}
                                    className="bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl py-3 px-4 font-semibold flex items-center justify-center gap-2 hover:from-blue-600 hover:to-blue-700 transition-all shadow-md"
                                >
                                    <Plus size={20} />
                                    Upload Photo
                                </button>
                            </div>

                            <button
                                onClick={requestPedometerPermission}
                                className="w-full mt-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl py-3 px-4 font-semibold flex items-center justify-center gap-2 hover:from-purple-600 hover:to-purple-700 transition-all shadow-md"
                            >
                                <Footprints size={20} />
                                Enable Step Counter
                            </button>
                        </div>

                        {/* Camera View */}
                        {showCamera && (
                            <div>
                                <div style={{
                                    position: 'fixed', 
                                    top: 0, 
                                    left: 0, 
                                    right: 0, 
                                    bottom: 0, 
                                    backgroundColor: 'black', 
                                    zIndex: 99999
                                }}>
                                    <video
                                        ref={videoRef}
                                        autoPlay
                                        playsInline
                                        muted
                                        style={{
                                            position: 'absolute',
                                            top: 0,
                                            left: 0,
                                            width: '100%',
                                            height: '100%',
                                            objectFit: 'cover'
                                        }}
                                    />
                                    <div style={{
                                        position: 'absolute',
                                        bottom: 0,
                                        left: 0,
                                        right: 0,
                                        backgroundColor: 'rgba(0,0,0,0.8)',
                                        padding: '30px 20px',
                                        display: 'flex',
                                        justifyContent: 'center',
                                        gap: '30px',
                                        zIndex: 100000
                                    }}>
                                        <button
                                            onClick={stopCamera}
                                            style={{
                                                backgroundColor: '#ef4444',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '12px',
                                                padding: '18px 30px',
                                                fontSize: '18px',
                                                fontWeight: 'bold',
                                                cursor: 'pointer',
                                                minWidth: '120px'
                                            }}
                                        >
                                            ‚úï Cancel
                                        </button>
                                        <button
                                            onClick={capturePhoto}
                                            style={{
                                                backgroundColor: '#22c55e',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '12px',
                                                padding: '18px 40px',
                                                fontSize: '18px',
                                                fontWeight: 'bold',
                                                cursor: 'pointer',
                                                minWidth: '150px'
                                            }}
                                        >
                                            üì∏ Capture
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Analysis Loading */}
                        {isAnalyzing && (
                            <div className="bg-white rounded-2xl shadow-lg p-8 mb-6 text-center">
                                <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-green-500 mx-auto mb-4"></div>
                                <p className="text-gray-600 font-medium">Analyzing your meal...</p>
                            </div>
                        )}

                        {/* Meals List */}
                        <div className="space-y-4">
                            {meals.map(meal => (
                                <div key={meal.id} className="bg-white rounded-2xl shadow-lg overflow-hidden">
                                    <div className="relative">
                                        <img 
                                            src={meal.image} 
                                            alt={meal.name}
                                            className="w-full h-48 object-cover"
                                        />
                                        <button
                                            onClick={() => deleteMeal(meal.id)}
                                            className="absolute top-2 right-2 bg-red-500 text-white rounded-full p-2 hover:bg-red-600 transition-colors"
                                        >
                                            <X size={16} />
                                        </button>
                                    </div>
                                    <div className="p-4">
                                        <h3 className="font-bold text-lg text-gray-800 mb-1">{meal.name}</h3>
                                        <p className="text-sm text-gray-500 mb-3">{meal.timestamp}</p>
                                        
                                        {meal.items && (
                                            <p className="text-sm text-gray-600 mb-3">
                                                <span className="font-medium">Items:</span> {meal.items.join(', ')}
                                            </p>
                                        )}
                                        
                                        <div className="grid grid-cols-5 gap-2">
                                            <div className="text-center bg-orange-50 rounded-lg p-2">
                                                <p className="text-xs text-orange-600 font-medium">Calories</p>
                                                <p className="text-lg font-bold text-orange-900">{Math.round(meal.calories)}</p>
                                            </div>
                                            <div className="text-center bg-purple-50 rounded-lg p-2">
                                                <p className="text-xs text-purple-600 font-medium">Protein</p>
                                                <p className="text-lg font-bold text-purple-900">{Math.round(meal.protein)}g</p>
                                            </div>
                                            <div className="text-center bg-yellow-50 rounded-lg p-2">
                                                <p className="text-xs text-yellow-600 font-medium">Carbs</p>
                                                <p className="text-lg font-bold text-yellow-900">{Math.round(meal.carbs)}g</p>
                                            </div>
                                            <div className="text-center bg-red-50 rounded-lg p-2">
                                                <p className="text-xs text-red-600 font-medium">Fat</p>
                                                <p className="text-lg font-bold text-red-900">{Math.round(meal.fat)}g</p>
                                            </div>
                                            <div className="text-center bg-green-50 rounded-lg p-2">
                                                <p className="text-xs text-green-600 font-medium">Fiber</p>
                                                <p className="text-lg font-bold text-green-900">{Math.round(meal.fiber)}g</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                            
                            {meals.length === 0 && !isAnalyzing && (
                                <div className="bg-white rounded-2xl shadow-lg p-12 text-center">
                                    <Camera size={48} className="mx-auto mb-4 text-gray-300" />
                                    <p className="text-gray-500 font-medium">No meals tracked yet</p>
                                    <p className="text-gray-400 text-sm mt-2">Scan or upload a photo to get started!</p>
                                </div>
                            )}
                        </div>

                        <input
                            ref={fileInputRef}
                            type="file"
                            accept="image/*"
                            onChange={handleFileUpload}
                            className="hidden"
                        />

                        <canvas ref={canvasRef} className="hidden" />
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MealTrackerApp />);
    </script>
</body>
</html>
