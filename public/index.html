<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CTRL-ALT-FIT - AI Nutrition Analysis</title>
    <meta name="description" content="CTRL-ALT-FIT: AI-powered meal tracking and nutrition analysis">
    <meta name="theme-color" content="#10b981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CTRL-ALT-FIT">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="icon" type="image/svg+xml" href="/icon.svg">
    <link rel="apple-touch-icon" href="/icon.svg">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        const parseGoogleCredential = (credential) => {
            try {
                const parts = credential.split('.');
                if (parts.length < 2) {
                    return null;
                }
                const payload = parts[1].replace(/-/g, '+').replace(/_/g, '/');
                const padded = payload + '='.repeat((4 - (payload.length % 4)) % 4);
                const json = atob(padded);
                return JSON.parse(json);
            } catch (error) {
                console.error('Failed to parse Google credential:', error);
                return null;
            }
        };
        const GROUPS_STORAGE_KEY = 'caf_groups_v1';

        // Lucide icons as inline SVG components
        const Camera = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/>
                <circle cx="12" cy="13" r="3"/>
            </svg>
        );

        const Footprints = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 10 3.8 10 5.5c0 3.11-2 5.66-2 8.68V16a2 2 0 1 1-4 0Z"/>
                <path d="M20 20v-2.38c0-2.12 1.03-3.12 1-5.62-.03-2.72-1.49-6-4.5-6C14.63 6 14 7.8 14 9.5c0 3.11 2 5.66 2 8.68V20a2 2 0 1 0 4 0Z"/>
            </svg>
        );

        const TrendingUp = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/>
                <polyline points="16 7 22 7 22 13"/>
            </svg>
        );

        const Plus = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
        );

        const X = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        );

        const CtrlAltFitLogo = ({ className = "" }) => (
            <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" className={className} aria-hidden="true">
                <defs>
                    <linearGradient id="cafLogoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stopColor="#10b981" />
                        <stop offset="100%" stopColor="#2563eb" />
                    </linearGradient>
                </defs>
                <rect x="4" y="4" width="56" height="56" rx="14" fill="url(#cafLogoGradient)" />
                <rect x="16" y="18" width="5" height="28" rx="2.5" fill="#ffffff" />
                <rect x="16" y="18" width="20" height="5" rx="2.5" fill="#ffffff" />
                <rect x="43" y="18" width="5" height="28" rx="2.5" fill="#ffffff" />
                <rect x="28" y="29.5" width="23" height="5" rx="2.5" fill="#ffffff" />
            </svg>
        );

        function MealTrackerApp() {
            const mealTypes = [
                { id: 'breakfast', label: 'Breakfast', icon: 'ðŸŒ…' },
                { id: 'lunch', label: 'Lunch', icon: 'â˜€ï¸' },
                { id: 'snack', label: 'Snack', icon: 'ðŸŽ' },
                { id: 'dinner', label: 'Dinner', icon: 'ðŸŒ™' },
                { id: 'other', label: 'Other', icon: 'ðŸ½ï¸' },
            ];
            const mealTypeMap = Object.fromEntries(mealTypes.map((type) => [type.id, type]));
            const [meals, setMeals] = useState([]);
            const [steps, setSteps] = useState(0);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [userProfile, setUserProfile] = useState(null);
            const [authError, setAuthError] = useState('');
            const [authConfigLoading, setAuthConfigLoading] = useState(true);
            const [googleClientId, setGoogleClientId] = useState(window.GOOGLE_CLIENT_ID || '');
            const [activeTab, setActiveTab] = useState('you');
            const [profileMenuOpen, setProfileMenuOpen] = useState(false);
            const [isEditProfileOpen, setIsEditProfileOpen] = useState(false);
            const [profileDraft, setProfileDraft] = useState({
                name: '',
                picture: '',
                age: '',
                sex: '',
            });
            const [groups, setGroups] = useState([]);
            const [isCreateGroupOpen, setIsCreateGroupOpen] = useState(false);
            const [newGroupName, setNewGroupName] = useState('');
            const [selectedGroupId, setSelectedGroupId] = useState(null);
            const [isAddMembersOpen, setIsAddMembersOpen] = useState(false);
            const [inviteEmail, setInviteEmail] = useState('');
            const [groupPostType, setGroupPostType] = useState('announcement');
            const [groupPostText, setGroupPostText] = useState('');
            const [selectedMealType, setSelectedMealType] = useState('breakfast');
            const [showCamera, setShowCamera] = useState(false);
            const [capturedImage, setCapturedImage] = useState(null);
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const fileInputRef = useRef(null);
            const googleButtonRef = useRef(null);
            const profileMenuRef = useRef(null);
            const profilePhotoInputRef = useRef(null);
            const joinInviteHandledRef = useRef(false);
            const streamRef = useRef(null);
            const stepListenerRef = useRef(null);
            const stepCounterActiveRef = useRef(false);
            const lastMotionYRef = useRef(null);
            const lastStepTimestampRef = useRef(0);
            const googleClientIdConfigured = Boolean(googleClientId && googleClientId.trim());

            useEffect(() => {
                const savedProfile = localStorage.getItem('userProfile');
                if (savedProfile) {
                    try {
                        setUserProfile(JSON.parse(savedProfile));
                    } catch (error) {
                        console.error('Failed to parse saved user profile:', error);
                        localStorage.removeItem('userProfile');
                    }
                }
            }, []);

            useEffect(() => {
                if (!userProfile || !userProfile.sub) {
                    return;
                }

                try {
                    const overridesRaw = localStorage.getItem(`userProfileOverrides:${userProfile.sub}`);
                    if (!overridesRaw) {
                        return;
                    }

                    const overrides = JSON.parse(overridesRaw);
                    setUserProfile((prev) => ({ ...prev, ...overrides }));
                } catch (error) {
                    console.error('Failed to load user profile overrides:', error);
                }
            }, [userProfile?.sub]);

            useEffect(() => {
                const loadConfig = async () => {
                    try {
                        const response = await fetch('/api/config');
                        if (!response.ok) {
                            throw new Error(`Config API failed: ${response.status}`);
                        }

                        const data = await response.json();
                        const envClientId = String(data?.googleClientId || '').trim();
                        if (envClientId) {
                            setGoogleClientId(envClientId);
                            window.GOOGLE_CLIENT_ID = envClientId;
                        } else {
                            setAuthError('Google Sign-In is not configured on server.');
                        }
                    } catch (error) {
                        console.error('Failed to load auth config:', error);
                        setAuthError('Could not load sign-in configuration.');
                    } finally {
                        setAuthConfigLoading(false);
                    }
                };

                loadConfig();
            }, []);

            useEffect(() => {
                if (userProfile) {
                    return;
                }

                if (authConfigLoading) {
                    return;
                }

                if (!googleClientIdConfigured) {
                    setAuthError('Google Sign-In is not configured yet.');
                    return;
                }

                let intervalId;
                const initGoogle = () => {
                    if (!window.google || !window.google.accounts || !googleButtonRef.current) {
                        return false;
                    }

                    window.google.accounts.id.initialize({
                        client_id: googleClientId,
                        callback: (response) => {
                            const claims = parseGoogleCredential(response.credential);
                            if (!claims) {
                                setAuthError('Failed to read Google profile data.');
                                return;
                            }

                            const profile = {
                                sub: claims.sub,
                                name: claims.name || '',
                                given_name: claims.given_name || '',
                                family_name: claims.family_name || '',
                                email: claims.email || '',
                                picture: claims.picture || '',
                            };

                            setUserProfile(profile);
                            localStorage.setItem('userProfile', JSON.stringify(profile));
                            setAuthError('');
                        },
                    });

                    googleButtonRef.current.innerHTML = '';
                    window.google.accounts.id.renderButton(googleButtonRef.current, {
                        type: 'standard',
                        theme: 'outline',
                        size: 'large',
                        shape: 'pill',
                        text: 'signin_with',
                        logo_alignment: 'left',
                        width: 260,
                    });
                    window.google.accounts.id.prompt();

                    return true;
                };

                if (!initGoogle()) {
                    intervalId = window.setInterval(() => {
                        if (initGoogle()) {
                            window.clearInterval(intervalId);
                        }
                    }, 250);
                }

                return () => {
                    if (intervalId) {
                        window.clearInterval(intervalId);
                    }
                };
            }, [userProfile, authConfigLoading, googleClientId, googleClientIdConfigured]);

            const signOut = () => {
                if (window.google && window.google.accounts && window.google.accounts.id) {
                    window.google.accounts.id.disableAutoSelect();
                }
                localStorage.removeItem('userProfile');
                setUserProfile(null);
                setActiveTab('you');
                setGroups([]);
                setSelectedGroupId(null);
                setProfileMenuOpen(false);
            };

            const persistGroups = (nextGroups) => {
                setGroups(nextGroups);
                localStorage.setItem(GROUPS_STORAGE_KEY, JSON.stringify(nextGroups));
            };

            const buildMemberFromProfile = (profile, stepCount = 0) => ({
                sub: profile?.sub || '',
                name: profile?.name || 'Unknown user',
                email: profile?.email || '',
                picture: profile?.picture || '',
                steps: Math.max(0, Math.round(Number(stepCount) || 0)),
            });

            const generateInviteCode = () => Math.random().toString(36).slice(2, 10).toUpperCase();

            useEffect(() => {
                if (!userProfile) {
                    return;
                }

                joinInviteHandledRef.current = false;
                setSelectedGroupId(null);
                try {
                    const raw = localStorage.getItem(GROUPS_STORAGE_KEY);
                    const parsed = raw ? JSON.parse(raw) : [];
                    setGroups(Array.isArray(parsed) ? parsed : []);
                } catch (error) {
                    console.error('Failed to load groups:', error);
                    setGroups([]);
                }
            }, [userProfile?.sub]);

            useEffect(() => {
                if (!userProfile || joinInviteHandledRef.current) {
                    return;
                }

                const params = new URLSearchParams(window.location.search);
                const joinCode = (params.get('join') || '').trim().toUpperCase();
                if (!joinCode) {
                    joinInviteHandledRef.current = true;
                    return;
                }

                const group = groups.find((g) => g.inviteCode === joinCode);
                if (!group) {
                    joinInviteHandledRef.current = true;
                    return;
                }

                const alreadyMember = (group.members || []).some((member) => member.sub === userProfile.sub);
                if (!alreadyMember) {
                    const updated = groups.map((g) => {
                        if (g.id !== group.id) {
                            return g;
                        }
                        return { ...g, members: [...(g.members || []), buildMemberFromProfile(userProfile, steps)] };
                    });
                    persistGroups(updated);
                }

                setActiveTab('groups');
                window.history.replaceState({}, '', window.location.pathname);
                joinInviteHandledRef.current = true;
            }, [groups, userProfile]);

            const createGroup = () => {
                const trimmedName = newGroupName.trim();
                if (!trimmedName || !userProfile) {
                    return;
                }

                const newGroup = {
                    id: `grp_${Date.now()}_${Math.random().toString(36).slice(2, 7)}`,
                    name: trimmedName,
                    ownerSub: userProfile.sub,
                    inviteCode: generateInviteCode(),
                    createdAt: new Date().toISOString(),
                    members: [buildMemberFromProfile(userProfile, steps)],
                    posts: [],
                };

                const nextGroups = [newGroup, ...groups];
                persistGroups(nextGroups);
                setNewGroupName('');
                setIsCreateGroupOpen(false);
                setSelectedGroupId(newGroup.id);
                setActiveTab('groups');
            };

            const inviteUrl = selectedGroup ? `${window.location.origin}${window.location.pathname}?join=${selectedGroup.inviteCode}` : '';

            const openAddMembers = () => {
                setInviteEmail('');
                setIsAddMembersOpen(true);
            };

            const sendEmailInvite = async () => {
                const trimmedEmail = inviteEmail.trim();
                if (!trimmedEmail || !selectedGroup || !inviteUrl) {
                    return;
                }

                const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(trimmedEmail);
                if (!emailOk) {
                    alert('Please enter a valid email address.');
                    return;
                }

                const subject = encodeURIComponent(`Join ${selectedGroup.name} on CTRL-ALT-FIT`);
                const body = encodeURIComponent(
                    `Hi,\n\nJoin my group "${selectedGroup.name}" on CTRL-ALT-FIT using this invite link:\n${inviteUrl}\n\nIf supported, you can also scan this invite from the app.\n`
                );
                const mailtoHref = `mailto:${trimmedEmail}?subject=${subject}&body=${body}`;

                try {
                    window.location.href = mailtoHref;
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(inviteUrl);
                    }
                    setIsAddMembersOpen(false);
                    setInviteEmail('');
                } catch (error) {
                    console.error('Failed to open email invite:', error);
                }
            };

            const postToGroupChat = () => {
                const text = groupPostText.trim();
                if (!selectedGroup || !text || !userProfile) {
                    return;
                }

                const newPost = {
                    id: `post_${Date.now()}_${Math.random().toString(36).slice(2, 7)}`,
                    type: groupPostType,
                    text,
                    createdAt: new Date().toISOString(),
                    author: {
                        sub: userProfile.sub,
                        name: userProfile.name || 'Member',
                        picture: userProfile.picture || '',
                    },
                };

                const updated = groups.map((group) => {
                    if (group.id !== selectedGroup.id) {
                        return group;
                    }
                    return {
                        ...group,
                        posts: [newPost, ...(Array.isArray(group.posts) ? group.posts : [])],
                    };
                });

                persistGroups(updated);
                setGroupPostText('');
                setGroupPostType('announcement');
            };

            useEffect(() => {
                if (!userProfile) {
                    return;
                }

                setGroups((prevGroups) => {
                    let changed = false;
                    const nextGroups = prevGroups.map((group) => {
                        const members = Array.isArray(group.members) ? group.members : [];
                        let memberChanged = false;
                        const nextMembers = members.map((member) => {
                            if (member.sub !== userProfile.sub) {
                                return member;
                            }

                            const nextSteps = Math.max(0, Math.round(Number(steps) || 0));
                            if ((member.steps || 0) === nextSteps) {
                                return member;
                            }

                            memberChanged = true;
                            return { ...member, steps: nextSteps };
                        });

                        if (!memberChanged) {
                            return group;
                        }

                        changed = true;
                        return { ...group, members: nextMembers };
                    });

                    if (changed) {
                        localStorage.setItem(GROUPS_STORAGE_KEY, JSON.stringify(nextGroups));
                        return nextGroups;
                    }

                    return prevGroups;
                });
            }, [steps, userProfile]);

            useEffect(() => {
                const onClickOutside = (event) => {
                    if (!profileMenuRef.current) {
                        return;
                    }

                    if (!profileMenuRef.current.contains(event.target)) {
                        setProfileMenuOpen(false);
                    }
                };

                window.addEventListener('click', onClickOutside);
                return () => window.removeEventListener('click', onClickOutside);
            }, []);

            // Load meals from localStorage on mount
            useEffect(() => {
                const savedMeals = localStorage.getItem('meals');
                if (savedMeals) {
                    try {
                        const parsedMeals = JSON.parse(savedMeals);
                        const normalizedMeals = Array.isArray(parsedMeals) ? parsedMeals.map((meal) => {
                            const fallbackDate = typeof meal?.id === 'number' ? new Date(meal.id) : new Date();
                            const fallbackIso = Number.isNaN(fallbackDate.getTime()) ? new Date().toISOString() : fallbackDate.toISOString();

                            return {
                                ...meal,
                                mealType: meal?.mealType || 'other',
                                createdAt: meal?.createdAt || fallbackIso,
                            };
                        }) : [];
                        setMeals(normalizedMeals);
                    } catch (error) {
                        console.error('Failed to parse saved meals:', error);
                        setMeals([]);
                    }
                }
            }, []);

            // Save meals to localStorage whenever they change
            useEffect(() => {
                localStorage.setItem('meals', JSON.stringify(meals));
            }, [meals]);

            // Step counter using device motion
            useEffect(() => {
                let stepCount = parseInt(localStorage.getItem('dailySteps') || '0');
                setSteps(stepCount);

                const now = new Date();
                const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                const msUntilMidnight = tomorrow - now;
                
                const midnightTimer = setTimeout(() => {
                    localStorage.setItem('dailySteps', '0');
                    setSteps(0);
                }, msUntilMidnight);

                return () => clearTimeout(midnightTimer);
            }, []);

            const requestPedometerPermission = async () => {
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    try {
                        const permission = await DeviceMotionEvent.requestPermission();
                        if (permission === 'granted') {
                            startStepCounting();
                            alert('Step counter enabled! Start walking to see it update.');
                        }
                    } catch (error) {
                        alert('Permission denied. Step counting requires motion sensor access.');
                    }
                } else {
                    alert('Step counter is only available on mobile devices with motion sensors (iPhone, Android phones).');
                }
            };

            const startStepCounting = () => {
                if (stepCounterActiveRef.current) {
                    return;
                }

                const threshold = 1.8;
                const minStepIntervalMs = 450;

                const onDeviceMotion = (event) => {
                    const acceleration = event.accelerationIncludingGravity;
                    if (!acceleration || typeof acceleration.y !== 'number') {
                        return;
                    }

                    const y = acceleration.y;

                    // Prime baseline on first reading to avoid false +1 step when enabling.
                    if (lastMotionYRef.current === null) {
                        lastMotionYRef.current = y;
                        return;
                    }

                    const delta = Math.abs(y - lastMotionYRef.current);
                    const now = Date.now();

                    if (delta > threshold && now - lastStepTimestampRef.current >= minStepIntervalMs) {
                        lastStepTimestampRef.current = now;
                        setSteps((prevSteps) => {
                            const nextSteps = prevSteps + 1;
                            localStorage.setItem('dailySteps', nextSteps.toString());
                            return nextSteps;
                        });
                    }

                    lastMotionYRef.current = y;
                };

                stepListenerRef.current = onDeviceMotion;
                stepCounterActiveRef.current = true;
                window.addEventListener('devicemotion', onDeviceMotion);
            };

            useEffect(() => {
                return () => {
                    if (stepListenerRef.current) {
                        window.removeEventListener('devicemotion', stepListenerRef.current);
                    }
                };
            }, []);

            const startCamera = async () => {
                if (!userProfile) {
                    alert('Please sign in with Google to log meals.');
                    return;
                }
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: { ideal: 'environment' },
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        } 
                    });
                    streamRef.current = stream;
                    setShowCamera(true);
                    
                    setTimeout(() => {
                        if (videoRef.current) {
                            videoRef.current.srcObject = stream;
                            videoRef.current.play().catch(err => {
                                console.error('Play error:', err);
                            });
                        }
                    }, 100);
                } catch (err) {
                    console.error('Camera access denied:', err);
                    alert('Camera access denied. Please grant camera permission or use the Upload Photo option instead.');
                }
            };

            const stopCamera = () => {
                if (streamRef.current) {
                    streamRef.current.getTracks().forEach(track => track.stop());
                    streamRef.current = null;
                }
                setShowCamera(false);
                setCapturedImage(null);
            };

            const capturePhoto = () => {
                const video = videoRef.current;
                const canvas = canvasRef.current;
                
                if (video && canvas) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0);
                    const imageData = canvas.toDataURL('image/jpeg', 0.8);
                    setCapturedImage(imageData);
                    stopCamera();
                    analyzeMeal(imageData);
                }
            };

            const handleFileUpload = (event) => {
                if (!userProfile) {
                    alert('Please sign in with Google to log meals.');
                    return;
                }
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setCapturedImage(e.target.result);
                        analyzeMeal(e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const analyzeMeal = async (imageData) => {
                if (!userProfile) {
                    alert('Please sign in with Google to log meals.');
                    return;
                }
                setIsAnalyzing(true);
                
                try {
                    const response = await fetch('/api/analyze-meal', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ imageData })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || `API error: ${response.status}`);
                    }

                    const nutritionData = await response.json();
                    const now = new Date();
                    
                    const newMeal = {
                        id: now.getTime(),
                        createdAt: now.toISOString(),
                        timestamp: now.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }),
                        mealType: selectedMealType,
                        ownerSub: userProfile?.sub || 'unknown-user',
                        image: imageData,
                        ...nutritionData
                    };
                    
                    setMeals(prev => [newMeal, ...prev]);
                } catch (error) {
                    console.error('Analysis error:', error);
                    alert('Failed to analyze meal. ' + error.message);
                } finally {
                    setIsAnalyzing(false);
                    setCapturedImage(null);
                }
            };

            const deleteMeal = (id) => {
                setMeals(prev => prev.filter(meal => meal.id !== id));
            };

            if (!userProfile) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50">
                        <div className="max-w-md mx-auto p-4 pt-16">
                            <div className="bg-white rounded-2xl shadow-lg p-8 text-center">
                                <CtrlAltFitLogo className="h-14 w-14 mx-auto mb-4" />
                                <h1 className="text-2xl font-bold text-gray-800 mb-2">CTRL-ALT-FIT</h1>
                                <p className="text-sm text-gray-600 mb-6">Sign in with Google to continue.</p>
                                {authConfigLoading ? (
                                    <p className="text-sm text-gray-500">Loading sign-in...</p>
                                ) : (
                                    <div className="flex justify-center mb-3">
                                        <div ref={googleButtonRef}></div>
                                    </div>
                                )}
                                {!googleClientIdConfigured && !authConfigLoading && (
                                    <p className="text-xs text-red-600">
                                        Set <code>GOOGLE_CLIENT_ID</code> in Vercel environment variables and redeploy.
                                    </p>
                                )}
                                {authError && (
                                    <p className="text-xs text-red-600">{authError}</p>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            const getMealDate = (meal) => {
                const candidates = [meal?.createdAt, meal?.timestamp];
                if (typeof meal?.id === 'number') {
                    candidates.push(meal.id);
                }

                for (const value of candidates) {
                    const parsed = new Date(value);
                    if (!Number.isNaN(parsed.getTime())) {
                        return parsed;
                    }
                }

                return new Date();
            };

            const isSameDay = (left, right) => (
                left.getFullYear() === right.getFullYear() &&
                left.getMonth() === right.getMonth() &&
                left.getDate() === right.getDate()
            );

            const now = new Date();
            const todaysMeals = meals.filter((meal) => {
                if (!userProfile) {
                    return false;
                }
                const ownerMatches = meal.ownerSub ? meal.ownerSub === userProfile.sub : true;
                return ownerMatches && isSameDay(getMealDate(meal), now);
            });
            const todaysMealsSorted = [...todaysMeals].sort((a, b) => getMealDate(b) - getMealDate(a));
            const selectedMealTypeMeta = mealTypeMap[selectedMealType] || mealTypeMap.other;
            const todaysCountByType = mealTypes.reduce((acc, type) => {
                acc[type.id] = todaysMeals.filter((meal) => (meal.mealType || 'other') === type.id).length;
                return acc;
            }, {});

            const groupedMeals = mealTypes.map((type) => {
                const entries = todaysMealsSorted.filter((meal) => (meal.mealType || 'other') === type.id);
                const calories = entries.reduce((sum, meal) => sum + (Number(meal.calories) || 0), 0);
                return { ...type, entries, calories };
            }).filter((group) => group.entries.length > 0);

            const todaysTotals = todaysMeals.reduce((acc, meal) => ({
                calories: acc.calories + (meal.calories || 0),
                protein: acc.protein + (meal.protein || 0),
                carbs: acc.carbs + (meal.carbs || 0),
                fat: acc.fat + (meal.fat || 0),
                fiber: acc.fiber + (meal.fiber || 0)
            }), { calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0 });
            const currentDateLabel = now.toLocaleDateString([], { weekday: 'long', month: 'short', day: 'numeric', year: 'numeric' });
            const caloriesBurnedEstimate = Math.round(steps * 0.04);
            const firstName = (userProfile?.given_name || userProfile?.name || 'User').split(' ')[0];
            const myGroups = groups.filter((group) => (group.members || []).some((member) => member.sub === userProfile?.sub));
            const selectedGroup = myGroups.find((group) => group.id === selectedGroupId) || null;
            const groupLeaderboard = selectedGroup
                ? [...(selectedGroup.members || [])].sort((left, right) => (Number(right.steps) || 0) - (Number(left.steps) || 0))
                : [];
            const groupPosts = selectedGroup
                ? [...(Array.isArray(selectedGroup.posts) ? selectedGroup.posts : [])].sort((left, right) => new Date(right.createdAt) - new Date(left.createdAt))
                : [];

            useEffect(() => {
                setGroupPostType('announcement');
                setGroupPostText('');
            }, [selectedGroupId]);

            const handleEditProfile = () => {
                setProfileDraft({
                    name: userProfile?.name || '',
                    picture: userProfile?.picture || '',
                    age: userProfile?.age ? String(userProfile.age) : '',
                    sex: userProfile?.sex || '',
                });
                setIsEditProfileOpen(true);
                setProfileMenuOpen(false);
            };

            const handleProfileDraftChange = (field, value) => {
                setProfileDraft((prev) => ({ ...prev, [field]: value }));
            };

            const handleProfilePhotoFile = (event) => {
                const file = event.target.files && event.target.files[0];
                if (!file) {
                    return;
                }

                if (!file.type.startsWith('image/')) {
                    alert('Please select an image file.');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    handleProfileDraftChange('picture', e.target.result);
                };
                reader.readAsDataURL(file);
            };

            const handleSaveProfile = () => {
                const ageValue = profileDraft.age === '' ? '' : Math.max(0, Math.round(Number(profileDraft.age) || 0));
                const nextProfile = {
                    ...userProfile,
                    name: profileDraft.name.trim() || userProfile?.name || '',
                    picture: profileDraft.picture || userProfile?.picture || '',
                    age: ageValue,
                    sex: profileDraft.sex || '',
                };

                setUserProfile(nextProfile);
                localStorage.setItem('userProfile', JSON.stringify(nextProfile));
                if (nextProfile.sub) {
                    const overrides = {
                        name: nextProfile.name,
                        picture: nextProfile.picture,
                        age: nextProfile.age,
                        sex: nextProfile.sex,
                    };
                    localStorage.setItem(`userProfileOverrides:${nextProfile.sub}`, JSON.stringify(overrides));
                }

                setIsEditProfileOpen(false);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50">
                    <div className="max-w-4xl mx-auto p-4">
                        <div className="sticky top-0 z-40 mb-3 rounded-2xl border border-gray-200 bg-white/95 backdrop-blur px-4 py-3 shadow-sm">
                            <div className="flex items-start justify-between gap-3">
                                <div className="flex items-center gap-3">
                                    <CtrlAltFitLogo className="h-11 w-11 shrink-0" />
                                    <div>
                                        <h1 className="text-3xl font-bold text-gray-800">CTRL-ALT-FIT</h1>
                                        <p className="text-sm font-medium text-gray-700">Welcome, {firstName}</p>
                                        <p className="text-sm text-gray-500">{currentDateLabel}</p>
                                    </div>
                                </div>

                                <div className="relative" ref={profileMenuRef}>
                                    <button
                                        onClick={() => setProfileMenuOpen((prev) => !prev)}
                                        className="inline-flex items-center justify-center rounded-full ring-2 ring-gray-200 hover:ring-green-300 transition-all"
                                    >
                                        {userProfile.picture ? (
                                            <img src={userProfile.picture} alt={userProfile.name || 'User'} className="h-10 w-10 rounded-full object-cover" />
                                        ) : (
                                            <div className="h-10 w-10 rounded-full bg-gray-300"></div>
                                        )}
                                    </button>

                                    {profileMenuOpen && (
                                        <div className="absolute right-0 mt-2 w-48 rounded-xl border border-gray-200 bg-white shadow-lg z-20 overflow-hidden text-left">
                                            <div className="px-3 py-2 border-b border-gray-100">
                                                <p className="text-sm font-semibold text-gray-800 truncate">{userProfile.name || 'Signed in user'}</p>
                                                <p className="text-xs text-gray-600 truncate">{userProfile.email || ''}</p>
                                            </div>
                                            <button
                                                onClick={handleEditProfile}
                                                className="w-full px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 text-left"
                                            >
                                                Edit Profile
                                            </button>
                                            <button
                                                onClick={signOut}
                                                className="w-full px-3 py-2 text-sm text-red-600 hover:bg-red-50 text-left"
                                            >
                                                Sign out
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="mb-4 rounded-2xl bg-white p-2 shadow-md">
                            <div className="grid grid-cols-2 gap-2">
                                <button
                                    onClick={() => setActiveTab('you')}
                                    className={`rounded-xl px-4 py-2 text-sm font-semibold transition-all ${
                                        activeTab === 'you'
                                            ? 'bg-green-600 text-white shadow'
                                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                    }`}
                                >
                                    You
                                </button>
                                <button
                                    onClick={() => setActiveTab('groups')}
                                    className={`rounded-xl px-4 py-2 text-sm font-semibold transition-all ${
                                        activeTab === 'groups'
                                            ? 'bg-green-600 text-white shadow'
                                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                    }`}
                                >
                                    Groups
                                </button>
                            </div>
                        </div>

                        {activeTab === 'you' ? (
                        <>
                        {/* Header */}
                        <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
                            {/* Daily Summary Cards */}
                            <div className="grid grid-cols-2 gap-3 mb-3">
                                <div className="bg-gradient-to-br from-orange-100 to-orange-200 rounded-xl p-4">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className="text-orange-700 text-sm font-medium">Today's Calories</p>
                                            <p className="text-3xl font-bold text-orange-900">{Math.round(todaysTotals.calories)}</p>
                                        </div>
                                        <TrendingUp size={32} className="text-orange-600" />
                                    </div>
                                </div>
                                
                                <div className="bg-gradient-to-br from-blue-100 to-blue-200 rounded-xl p-4">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className="text-blue-700 text-sm font-medium">Steps Today</p>
                                            <p className="text-3xl font-bold text-blue-900">{steps.toLocaleString()}</p>
                                        </div>
                                        <Footprints size={32} className="text-blue-600" />
                                    </div>
                                </div>
                            </div>

                            <div className="mb-4">
                                <div className="bg-gradient-to-br from-emerald-100 to-emerald-200 rounded-xl p-4">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className="text-emerald-700 text-sm font-medium">Calories Burned</p>
                                            <p className="text-3xl font-bold text-emerald-900">{caloriesBurnedEstimate}</p>
                                            <p className="text-xs text-emerald-700 mt-1">Estimated from steps</p>
                                        </div>
                                        <TrendingUp size={32} className="text-emerald-600" />
                                    </div>
                                </div>
                            </div>

                            {/* Macros Summary */}
                            <div className="grid grid-cols-4 gap-3 mb-4">
                                <div className="bg-purple-50 rounded-lg p-3 text-center">
                                    <p className="text-xs text-purple-600 font-medium">Protein</p>
                                    <p className="text-xl font-bold text-purple-900">{Math.round(todaysTotals.protein)}g</p>
                                </div>
                                <div className="bg-yellow-50 rounded-lg p-3 text-center">
                                    <p className="text-xs text-yellow-600 font-medium">Carbs</p>
                                    <p className="text-xl font-bold text-yellow-900">{Math.round(todaysTotals.carbs)}g</p>
                                </div>
                                <div className="bg-red-50 rounded-lg p-3 text-center">
                                    <p className="text-xs text-red-600 font-medium">Fat</p>
                                    <p className="text-xl font-bold text-red-900">{Math.round(todaysTotals.fat)}g</p>
                                </div>
                                <div className="bg-green-50 rounded-lg p-3 text-center">
                                    <p className="text-xs text-green-600 font-medium">Fiber</p>
                                    <p className="text-xl font-bold text-green-900">{Math.round(todaysTotals.fiber)}g</p>
                                </div>
                            </div>

                            <div className="mb-4 rounded-xl border border-emerald-100 bg-emerald-50 px-3 py-2 text-sm text-emerald-800">
                                AI Model: Gemini 2.5 Flash-Lite (Free Tier)
                            </div>

                            <div className="mb-4">
                                <p className="text-sm font-semibold text-gray-700 mb-2">Log This As</p>
                                <div className="grid grid-cols-2 md:grid-cols-5 gap-2">
                                    {mealTypes.map((mealType) => {
                                        const isActive = selectedMealType === mealType.id;
                                        const count = todaysCountByType[mealType.id] || 0;
                                        return (
                                            <button
                                                key={mealType.id}
                                                onClick={() => setSelectedMealType(mealType.id)}
                                                className={`rounded-xl border px-3 py-2 text-left transition-all ${
                                                    isActive
                                                        ? 'border-green-500 bg-green-50 shadow-sm'
                                                        : 'border-gray-200 bg-white hover:border-green-300'
                                                }`}
                                            >
                                                <p className="text-sm font-semibold text-gray-800">{mealType.icon} {mealType.label}</p>
                                                <p className="text-xs text-gray-500">{count} today</p>
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>

                            {/* Action Buttons */}
                            <div className="grid grid-cols-2 gap-3">
                                <button
                                    onClick={startCamera}
                                    className={`rounded-xl py-3 px-4 font-semibold flex items-center justify-center gap-2 transition-all shadow-md ${
                                        userProfile
                                            ? 'bg-gradient-to-r from-green-500 to-green-600 text-white hover:from-green-600 hover:to-green-700'
                                            : 'bg-gray-300 text-gray-600 cursor-not-allowed'
                                    }`}
                                    disabled={!userProfile}
                                >
                                    <Camera size={20} />
                                    Scan {selectedMealTypeMeta.label}
                                </button>
                                
                                <button
                                    onClick={() => {
                                        if (!userProfile) {
                                            alert('Please sign in with Google to log meals.');
                                            return;
                                        }
                                        fileInputRef.current.click();
                                    }}
                                    className={`rounded-xl py-3 px-4 font-semibold flex items-center justify-center gap-2 transition-all shadow-md ${
                                        userProfile
                                            ? 'bg-gradient-to-r from-blue-500 to-blue-600 text-white hover:from-blue-600 hover:to-blue-700'
                                            : 'bg-gray-300 text-gray-600 cursor-not-allowed'
                                    }`}
                                    disabled={!userProfile}
                                >
                                    <Plus size={20} />
                                    Upload {selectedMealTypeMeta.label}
                                </button>
                            </div>

                            <button
                                onClick={requestPedometerPermission}
                                className="w-full mt-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl py-3 px-4 font-semibold flex items-center justify-center gap-2 hover:from-purple-600 hover:to-purple-700 transition-all shadow-md"
                            >
                                <Footprints size={20} />
                                Enable Step Counter
                            </button>
                        </div>

                        {/* Camera View */}
                        {showCamera && (
                            <div>
                                <div style={{
                                    position: 'fixed', 
                                    top: 0, 
                                    left: 0, 
                                    right: 0, 
                                    bottom: 0, 
                                    backgroundColor: 'black', 
                                    zIndex: 99999
                                }}>
                                    <video
                                        ref={videoRef}
                                        autoPlay
                                        playsInline
                                        muted
                                        style={{
                                            position: 'absolute',
                                            top: 0,
                                            left: 0,
                                            width: '100%',
                                            height: '100%',
                                            objectFit: 'cover'
                                        }}
                                    />
                                    <div style={{
                                        position: 'absolute',
                                        bottom: 0,
                                        left: 0,
                                        right: 0,
                                        backgroundColor: 'rgba(0,0,0,0.8)',
                                        padding: '30px 20px',
                                        display: 'flex',
                                        justifyContent: 'center',
                                        gap: '30px',
                                        zIndex: 100000
                                    }}>
                                        <button
                                            onClick={stopCamera}
                                            style={{
                                                backgroundColor: '#ef4444',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '12px',
                                                padding: '18px 30px',
                                                fontSize: '18px',
                                                fontWeight: 'bold',
                                                cursor: 'pointer',
                                                minWidth: '120px'
                                            }}
                                        >
                                            âœ• Cancel
                                        </button>
                                        <button
                                            onClick={capturePhoto}
                                            style={{
                                                backgroundColor: '#22c55e',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '12px',
                                                padding: '18px 40px',
                                                fontSize: '18px',
                                                fontWeight: 'bold',
                                                cursor: 'pointer',
                                                minWidth: '150px'
                                            }}
                                        >
                                            ðŸ“¸ Capture
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Analysis Loading */}
                        {isAnalyzing && (
                            <div className="bg-white rounded-2xl shadow-lg p-8 mb-6 text-center">
                                <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-green-500 mx-auto mb-4"></div>
                                <p className="text-gray-600 font-medium">Analyzing your meal...</p>
                            </div>
                        )}

                        {/* Meals List */}
                        <div className="space-y-4">
                            {groupedMeals.map((group) => (
                                <div key={group.id} className="bg-white rounded-2xl shadow-lg overflow-hidden">
                                    <div className="bg-gradient-to-r from-gray-50 to-slate-50 border-b border-gray-200 px-4 py-3 flex items-center justify-between">
                                        <h2 className="text-base font-bold text-gray-800">{group.icon} {group.label}</h2>
                                        <p className="text-sm text-gray-600">{group.entries.length} meal{group.entries.length > 1 ? 's' : ''} â€¢ {Math.round(group.calories)} kcal</p>
                                    </div>
                                    <div className="p-4 space-y-4">
                                        {group.entries.map((meal) => (
                                            <div key={meal.id} className="rounded-xl border border-gray-200 overflow-hidden">
                                                <div className="relative">
                                                    <img 
                                                        src={meal.image} 
                                                        alt={meal.name}
                                                        className="w-full h-48 object-cover"
                                                    />
                                                    <button
                                                        onClick={() => deleteMeal(meal.id)}
                                                        className="absolute top-2 right-2 bg-red-500 text-white rounded-full p-2 hover:bg-red-600 transition-colors"
                                                    >
                                                        <X size={16} />
                                                    </button>
                                                </div>
                                                <div className="p-4">
                                                    <h3 className="font-bold text-lg text-gray-800 mb-1">{meal.name}</h3>
                                                    <p className="text-sm text-gray-500 mb-3">{meal.timestamp || getMealDate(meal).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })}</p>
                                                    
                                                    {meal.items && meal.items.length > 0 && (
                                                        <div className="mb-3">
                                                            <p className="text-sm font-medium text-gray-700 mb-1">Items & quantity</p>
                                                            {Array.isArray(meal.itemDetails) && meal.itemDetails.length > 0 ? (
                                                                <div className="flex flex-wrap gap-2">
                                                                    {meal.itemDetails.map((item, index) => (
                                                                        <span key={`${item.name}-${index}`} className="rounded-full bg-gray-100 px-2.5 py-1 text-xs text-gray-700">
                                                                            {item.name}: {Math.round(Number(item.quantity_g) || 0)}g
                                                                        </span>
                                                                    ))}
                                                                </div>
                                                            ) : (
                                                                <p className="text-sm text-gray-600">
                                                                    {meal.items.join(', ')}
                                                                </p>
                                                            )}
                                                        </div>
                                                    )}
                                                    
                                                    <div className="grid grid-cols-5 gap-2">
                                                        <div className="text-center bg-orange-50 rounded-lg p-2">
                                                            <p className="text-xs text-orange-600 font-medium">Calories</p>
                                                            <p className="text-lg font-bold text-orange-900">{Math.round(meal.calories)}</p>
                                                        </div>
                                                        <div className="text-center bg-purple-50 rounded-lg p-2">
                                                            <p className="text-xs text-purple-600 font-medium">Protein</p>
                                                            <p className="text-lg font-bold text-purple-900">{Math.round(meal.protein)}g</p>
                                                        </div>
                                                        <div className="text-center bg-yellow-50 rounded-lg p-2">
                                                            <p className="text-xs text-yellow-600 font-medium">Carbs</p>
                                                            <p className="text-lg font-bold text-yellow-900">{Math.round(meal.carbs)}g</p>
                                                        </div>
                                                        <div className="text-center bg-red-50 rounded-lg p-2">
                                                            <p className="text-xs text-red-600 font-medium">Fat</p>
                                                            <p className="text-lg font-bold text-red-900">{Math.round(meal.fat)}g</p>
                                                        </div>
                                                        <div className="text-center bg-green-50 rounded-lg p-2">
                                                            <p className="text-xs text-green-600 font-medium">Fiber</p>
                                                            <p className="text-lg font-bold text-green-900">{Math.round(meal.fiber)}g</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}

                            {todaysMeals.length === 0 && !isAnalyzing && (
                                <div className="bg-white rounded-2xl shadow-lg p-12 text-center">
                                    <Camera size={48} className="mx-auto mb-4 text-gray-300" />
                                    <p className="text-gray-500 font-medium">No meals logged for today</p>
                                    <p className="text-gray-400 text-sm mt-2">Pick a meal slot and scan your first meal.</p>
                                </div>
                            )}
                        </div>
                        </>
                        ) : (
                        <div className="space-y-4">
                            {!selectedGroup && (
                                <button
                                    onClick={() => setIsCreateGroupOpen(true)}
                                    className="w-full rounded-xl bg-gradient-to-r from-green-600 to-emerald-600 px-4 py-3 text-sm font-semibold text-white shadow hover:from-green-700 hover:to-emerald-700"
                                >
                                    + Create Group
                                </button>
                            )}

                            {selectedGroup ? (
                                <div className="space-y-3">
                                    <div className="bg-white rounded-2xl shadow-lg p-5">
                                        <div className="flex items-center justify-between gap-3">
                                            <button
                                                onClick={() => setSelectedGroupId(null)}
                                                className="rounded-lg border border-gray-300 px-3 py-1.5 text-xs font-semibold text-gray-700 hover:bg-gray-50"
                                            >
                                                â† Back
                                            </button>
                                            <button
                                                onClick={openAddMembers}
                                                className="rounded-lg border border-gray-300 px-3 py-1.5 text-xs font-semibold text-gray-700 hover:bg-gray-50"
                                            >
                                                Add Members
                                            </button>
                                        </div>
                                        <h2 className="text-xl font-bold text-gray-800 mt-3">{selectedGroup.name}</h2>
                                        <p className="text-sm text-gray-500">Leaderboard by steps</p>
                                    </div>

                                    <div className="bg-white rounded-2xl shadow-lg p-5 space-y-2">
                                        {groupLeaderboard.map((member, index) => (
                                            <div key={member.sub || index} className="flex items-center justify-between rounded-xl border border-gray-100 px-3 py-2">
                                                <div className="flex items-center gap-3">
                                                    <p className="w-6 text-sm font-bold text-gray-500">#{index + 1}</p>
                                                    {member.picture ? (
                                                        <img src={member.picture} alt={member.name} className="h-8 w-8 rounded-full object-cover" />
                                                    ) : (
                                                        <div className="h-8 w-8 rounded-full bg-gray-200"></div>
                                                    )}
                                                    <p className="text-sm font-medium text-gray-800">{member.name || 'Member'}</p>
                                                </div>
                                                <p className="text-sm font-bold text-blue-700">{(member.steps || 0).toLocaleString()} steps</p>
                                            </div>
                                        ))}
                                        {groupLeaderboard.length === 0 && (
                                            <p className="text-sm text-gray-500">No members yet.</p>
                                        )}
                                    </div>

                                    <div className="bg-white rounded-2xl shadow-lg p-5">
                                        <h3 className="text-lg font-bold text-gray-800 mb-1">Group Chat</h3>
                                        <p className="text-sm text-gray-500 mb-3">Post announcements and challenges for your group.</p>

                                        <div className="space-y-2 mb-4">
                                            <div className="grid grid-cols-2 gap-2">
                                                <button
                                                    onClick={() => setGroupPostType('announcement')}
                                                    className={`rounded-lg px-3 py-2 text-sm font-semibold ${
                                                        groupPostType === 'announcement'
                                                            ? 'bg-blue-600 text-white'
                                                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                                    }`}
                                                >
                                                    Announcement
                                                </button>
                                                <button
                                                    onClick={() => setGroupPostType('challenge')}
                                                    className={`rounded-lg px-3 py-2 text-sm font-semibold ${
                                                        groupPostType === 'challenge'
                                                            ? 'bg-purple-600 text-white'
                                                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                                    }`}
                                                >
                                                    Challenge
                                                </button>
                                            </div>
                                            <textarea
                                                value={groupPostText}
                                                onChange={(event) => setGroupPostText(event.target.value)}
                                                placeholder={groupPostType === 'announcement' ? 'Write an announcement...' : 'Write a challenge...'}
                                                className="w-full rounded-xl border border-gray-300 px-3 py-2 text-sm focus:border-green-500 focus:outline-none focus:ring-2 focus:ring-green-200"
                                                rows={3}
                                            />
                                            <div className="flex justify-end">
                                                <button
                                                    onClick={postToGroupChat}
                                                    disabled={!groupPostText.trim()}
                                                    className="rounded-xl bg-green-600 px-4 py-2 text-sm font-semibold text-white hover:bg-green-700 disabled:bg-gray-300"
                                                >
                                                    Post
                                                </button>
                                            </div>
                                        </div>

                                        <div className="space-y-2 max-h-72 overflow-y-auto pr-1">
                                            {groupPosts.length === 0 ? (
                                                <p className="text-sm text-gray-500">No posts yet. Share your first update.</p>
                                            ) : (
                                                groupPosts.map((post) => (
                                                    <div key={post.id} className="rounded-xl border border-gray-100 p-3">
                                                        <div className="flex items-center justify-between gap-2 mb-1">
                                                            <div className="flex items-center gap-2">
                                                                {post.author?.picture ? (
                                                                    <img src={post.author.picture} alt={post.author.name || 'Author'} className="h-6 w-6 rounded-full object-cover" />
                                                                ) : (
                                                                    <div className="h-6 w-6 rounded-full bg-gray-200"></div>
                                                                )}
                                                                <p className="text-sm font-semibold text-gray-800">{post.author?.name || 'Member'}</p>
                                                                <span className={`rounded-full px-2 py-0.5 text-[10px] font-semibold uppercase ${
                                                                    post.type === 'challenge'
                                                                        ? 'bg-purple-100 text-purple-700'
                                                                        : 'bg-blue-100 text-blue-700'
                                                                }`}>
                                                                    {post.type}
                                                                </span>
                                                            </div>
                                                            <p className="text-xs text-gray-500">{new Date(post.createdAt).toLocaleString([], { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' })}</p>
                                                        </div>
                                                        <p className="text-sm text-gray-700 whitespace-pre-wrap">{post.text}</p>
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    </div>
                                </div>
                            ) : myGroups.length === 0 ? (
                                <div className="bg-white rounded-2xl shadow-lg p-8 text-center">
                                    <p className="text-gray-600 font-medium">No groups yet.</p>
                                    <p className="text-sm text-gray-500 mt-1">Create a group and invite members by email.</p>
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    {myGroups.map((group) => (
                                        <button
                                            key={group.id}
                                            onClick={() => setSelectedGroupId(group.id)}
                                            className="w-full bg-white rounded-2xl shadow-lg p-5 text-left hover:shadow-xl transition-shadow"
                                        >
                                            <div className="flex items-start justify-between gap-3">
                                                <div>
                                                    <h3 className="text-lg font-bold text-gray-800">{group.name}</h3>
                                                    <p className="text-sm text-gray-500">{(group.members || []).length} member{(group.members || []).length > 1 ? 's' : ''}</p>
                                                </div>
                                                <span className="text-xs font-semibold text-green-700">Open â†’</span>
                                            </div>
                                        </button>
                                    ))}
                                </div>
                            )}
                        </div>
                        )}

                        {isCreateGroupOpen && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
                                <div className="w-full max-w-md rounded-2xl bg-white shadow-2xl">
                                    <div className="border-b border-gray-200 px-5 py-4">
                                        <h2 className="text-lg font-bold text-gray-800">Create Group</h2>
                                        <p className="text-xs text-gray-500 mt-1">Give your group a name, then invite members by email.</p>
                                    </div>
                                    <div className="px-5 py-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Group Name</label>
                                        <input
                                            type="text"
                                            value={newGroupName}
                                            onChange={(event) => setNewGroupName(event.target.value)}
                                            className="w-full rounded-xl border border-gray-300 px-3 py-2 text-sm focus:border-green-500 focus:outline-none focus:ring-2 focus:ring-green-200"
                                            placeholder="e.g. Fit Friends"
                                        />
                                    </div>
                                    <div className="flex justify-end gap-2 border-t border-gray-200 px-5 py-4">
                                        <button
                                            onClick={() => setIsCreateGroupOpen(false)}
                                            className="rounded-xl border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            onClick={createGroup}
                                            disabled={!newGroupName.trim()}
                                            className="rounded-xl bg-green-600 px-4 py-2 text-sm font-semibold text-white hover:bg-green-700 disabled:bg-gray-300"
                                        >
                                            Create
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {isAddMembersOpen && selectedGroup && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
                                <div className="w-full max-w-md rounded-2xl bg-white shadow-2xl">
                                    <div className="border-b border-gray-200 px-5 py-4">
                                        <h2 className="text-lg font-bold text-gray-800">Add Members</h2>
                                        <p className="text-xs text-gray-500 mt-1">Send a join invite for {selectedGroup.name} by email.</p>
                                    </div>
                                    <div className="space-y-3 px-5 py-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                            <input
                                                type="email"
                                                value={inviteEmail}
                                                onChange={(event) => setInviteEmail(event.target.value)}
                                                placeholder="person@example.com"
                                                className="w-full rounded-xl border border-gray-300 px-3 py-2 text-sm focus:border-green-500 focus:outline-none focus:ring-2 focus:ring-green-200"
                                            />
                                        </div>
                                        <p className="text-xs text-gray-500">
                                            This opens your default email app with a prefilled invite.
                                        </p>
                                    </div>
                                    <div className="flex justify-end gap-2 border-t border-gray-200 px-5 py-4">
                                        <button
                                            onClick={() => setIsAddMembersOpen(false)}
                                            className="rounded-xl border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            onClick={sendEmailInvite}
                                            disabled={!inviteEmail.trim()}
                                            className="rounded-xl bg-green-600 px-4 py-2 text-sm font-semibold text-white hover:bg-green-700 disabled:bg-gray-300"
                                        >
                                            Send Invite
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {isEditProfileOpen && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
                                <div className="w-full max-w-md rounded-2xl bg-white shadow-2xl">
                                    <div className="border-b border-gray-200 px-5 py-4">
                                        <h2 className="text-lg font-bold text-gray-800">Edit Profile</h2>
                                        <p className="text-xs text-gray-500 mt-1">Update your basic details.</p>
                                    </div>

                                    <div className="space-y-4 px-5 py-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Name</label>
                                            <input
                                                type="text"
                                                value={profileDraft.name}
                                                onChange={(event) => handleProfileDraftChange('name', event.target.value)}
                                                className="w-full rounded-xl border border-gray-300 px-3 py-2 text-sm focus:border-green-500 focus:outline-none focus:ring-2 focus:ring-green-200"
                                                placeholder="Your full name"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Profile Picture URL</label>
                                            <input
                                                type="url"
                                                value={profileDraft.picture}
                                                onChange={(event) => handleProfileDraftChange('picture', event.target.value)}
                                                className="w-full rounded-xl border border-gray-300 px-3 py-2 text-sm focus:border-green-500 focus:outline-none focus:ring-2 focus:ring-green-200"
                                                placeholder="https://..."
                                            />
                                            <div className="mt-2 flex items-center gap-2">
                                                <button
                                                    onClick={() => profilePhotoInputRef.current && profilePhotoInputRef.current.click()}
                                                    className="rounded-lg border border-gray-300 px-3 py-1.5 text-xs font-medium text-gray-700 hover:bg-gray-50"
                                                >
                                                    Upload Photo
                                                </button>
                                                {profileDraft.picture && (
                                                    <img src={profileDraft.picture} alt="Profile preview" className="h-8 w-8 rounded-full object-cover ring-1 ring-gray-300" />
                                                )}
                                            </div>
                                            <input
                                                ref={profilePhotoInputRef}
                                                type="file"
                                                accept="image/*"
                                                onChange={handleProfilePhotoFile}
                                                className="hidden"
                                            />
                                        </div>

                                        <div className="grid grid-cols-2 gap-3">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Age</label>
                                                <input
                                                    type="number"
                                                    min="0"
                                                    max="120"
                                                    value={profileDraft.age}
                                                    onChange={(event) => handleProfileDraftChange('age', event.target.value)}
                                                    className="w-full rounded-xl border border-gray-300 px-3 py-2 text-sm focus:border-green-500 focus:outline-none focus:ring-2 focus:ring-green-200"
                                                    placeholder="e.g. 28"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Sex</label>
                                                <select
                                                    value={profileDraft.sex}
                                                    onChange={(event) => handleProfileDraftChange('sex', event.target.value)}
                                                    className="w-full rounded-xl border border-gray-300 px-3 py-2 text-sm focus:border-green-500 focus:outline-none focus:ring-2 focus:ring-green-200"
                                                >
                                                    <option value="">Select</option>
                                                    <option value="Female">Female</option>
                                                    <option value="Male">Male</option>
                                                    <option value="Other">Other</option>
                                                    <option value="Prefer not to say">Prefer not to say</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="flex justify-end gap-2 border-t border-gray-200 px-5 py-4">
                                        <button
                                            onClick={() => setIsEditProfileOpen(false)}
                                            className="rounded-xl border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            onClick={handleSaveProfile}
                                            className="rounded-xl bg-green-600 px-4 py-2 text-sm font-semibold text-white hover:bg-green-700"
                                        >
                                            Save Changes
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        <input
                            ref={fileInputRef}
                            type="file"
                            accept="image/*"
                            onChange={handleFileUpload}
                            className="hidden"
                        />

                        <canvas ref={canvasRef} className="hidden" />
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MealTrackerApp />);
    </script>
</body>
</html>
